<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">
  <body>

    <metal:main fill-slot="main">
      <metal:main define-macro="main">

    <link rel="stylesheet" href="++resource++collective.resourcemanager/crs.css" />

    <tal:sources repeat="resource view/resources">
        <h1 class="documentFirstHeading">${resource/__doc__}</h1>
        <form action="" method="POST"
              tal:define="images resource/image_urls">
          <div class="fieldErrorBox"></div>
          <label for="rs_search">Search</label>:<br />
          <input id="rs_search" name="rs_search" type="text"
                 style="display: inline-block; width: 50%">
          <span tal:replace="structure context/@@authenticator/authenticator"/>
          <input class="standalone" value="Submit" type="submit" id="search-submit"
                 i18n:domain="plone" i18n:attributes="value"/>
          <hr />

            <tal:messages repeat="message resource/messages">
                ${message}<br />
            </tal:messages>

            <div class="rsresults">
                <tal:imgs condition="images">
                    Results 1-100 out of ${resource/num_results}<br />
                    <div class="rs-result"
                         tal:repeat="image images">
                        <div class="rs-metadata"
                             tal:define="item python:resource.image_metadata[image]">
                             <strong>title:</strong> ${item/field8}<br />
                             <strong>id:</strong> ${item/ref}<br />
                             <strong>created:</strong> ${item/creation_date}<br />
                             <strong>ext:</strong> ${item/file_extension}<br />
                             <span class="imageaction" data-url="${python:images[image]}">
                                 Use this image
                             </span>
                        </div>
                        <img src="${python:images[image]}" />
                    </div>
                </tal:imgs>
            </div>
            <div id='rscollections'
                 tal:attributes="style python:images and 'display:none' or ''">
                <h2>Browse Collections</h2>
                <div class="rs-result"
                     tal:define="images resource/collections"
                     tal:repeat="image images">
                    <strong>title:</strong> <input name="rs_browse" class="browse-submit" value="${image/name}" type="submit"/><br />
                    <strong>created:</strong> ${image/created}<br />
                    <strong>keywords:</strong> ${image/keywords}<br />
                </div>
            </div>
        </form>

    <script type="text/javascript">
        function populate_results(data) {
            var imagedata = JSON.parse(data);
            var errors = imagedata['errors'];
            var metadata = imagedata['metadata'];
            var urls = imagedata['urls'];
            var search_context = imagedata['search_context']
            var results = '<p class="showbrowser">&lt; Browse the Collections</p>';
            for (error in errors) {
                err_str = errors[error].replace(/\&/g, '&amp;');
                results += '<p style="color: red">' + err_str + '</p>'
            }
            if (urls.length == 0) {
                results += '<p>No images found</p>';
            }
            for (item in urls) {
                results += '<div class="rs-result">';
                results += '<div class="rs-metadata">';
                results += '<strong>title:</strong> <span class="rs-title">' + metadata[item].field8 + '</span><br />';
                results += '<strong>id:</strong> ' + metadata[item].ref + '<br />';
                results += '<strong>created:</strong> ' + metadata[item].creation_date + '<br />';
                results += '<strong>ext:</strong> ' + metadata[item].file_extension + '<br />';
                results += '<span class="imageaction ' + search_context + '" data-url=' + metadata[item].url + '>Use this image</span><br />';
                results += '<strong>in folder:</strong> ' + metadata[item].exists + '<br />';
                results += '</div>';
                results += '<img src=' + urls[item] + ' />';
                results += '</div>';
            }
            $('.rsresults').html($('.rsresults').html() + results);
            $('.rsresults h2').removeClass('loading');
        }
        function do_ajax_search(searchterm) {
            $('.rsresults').empty();
            $('#rscollections').hide();
            $('.rsresults').html('<h2 class="loading">Results for ' + searchterm + '</h2>')
            $.ajax({
                headers: { Accept: "application/json"},
                url: "<tal:context replace="resource/search_context" />",
                type: "GET",
                data: {
                    rs_search: searchterm,
                    type: 'json'
                },
                success: function(data) {
                    populate_results(data);
                }
            });
        }
        (function($) { $(function() {
            $('#search-submit').click(function(e){
                e.preventDefault();
                do_ajax_search($('#rs_search').val());
            });
            $('.browse-submit').click(function(e){
                e.preventDefault();
                do_ajax_search($(this).val());
            });
            $('.rsresults').on('click', '.imageaction', function(){
                if ($(this).parents('.plone-modal').length) {
                    document.getElementById("rs-url-input").value = $(this).attr('data-url');
                    $(this).trigger("destroy.plone-modal.patterns");
                } else {
                    $.ajax({
                        headers: { Accept: "application/json"},
                        url: "copy-img-from-rs",
                        type: "POST",
                        data: {
                            image: $(this).attr('data-url'),
                            title: $(this).parents('.rs-result').find('.rs-title').text(),
                            type: 'json'
                        },
                        success: function(data) {
                            console.log(data)
                        }
                    });
                }
            });
            $('.rsresults').on('click', '.showbrowser', function(){
                $('.rsresults').empty();
                $('#rscollections').show();
            });
        }); })(jQuery);
    </script>
</tal:sources>

      </metal:main>
    </metal:main>

  </body>
</html>
